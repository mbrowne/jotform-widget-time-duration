<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
      }

      input {
        height: 2.5em;
        width: 2.5em;
        padding: 0 0.625em;
      }

      form {
        display: flex;
        align-items: end;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #errors {
        color: red;
        margin: 0;
      }

      .duration-inputs {
        display: flex;
        align-items: end;
        line-height: 2.5;
        gap: 0.3rem;

        label {
          display: flex;
          flex-direction: column;
          color: gray;
          font-size: 0.8rem;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <form id="form">
      <div class="duration-inputs">
        <label>
          Hrs
          <input
            type="text"
            id="hours"
            name="hours"
            maxlength="3"
            inputmode="numeric"
          />
        </label>
        :
        <label>
          Min
          <input
            type="text"
            name="minutes"
            maxlength="2"
            inputmode="numeric"
            required
          />
        </label>
        :
        <label>
          Sec
          <input
            type="text"
            name="seconds"
            maxlength="2"
            inputmode="numeric"
            required
          />
        </label>
      </div>
      <p id="errors"></p>
    </form>
    <script>
      const form = document.getElementById('form')

      const integerRegex = /^\d+$/
      const errorsContainer = document.getElementById('errors')
      const validationErrors = new Map()

      let prevValue = ''
      form.addEventListener('input', (e) => {
        e.preventDefault()
        const { value } = e.target

        // only allow integer input
        if (value != '' && !integerRegex.test(value)) {
          e.preventDefault()
          e.target.value = prevValue
        } else {
          prevValue = value
        }

        validateField(e.target.name, value)
      })

      form.addEventListener('focusout', (e) => {
        const { target } = e
        if (!isNaN(parseInt(target.value))) {
          target.value = target.value.padStart(2, '0')
        } else if (target.name != 'hours' && !allFieldsEmpty()) {
          target.value = '00'
        }

        validateField(target.name, target.value)
        validateGeneral()

        if (validationErrors.size == 0) {
          //temp
          console.log('calling sendData')

          JFCustomWidget.sendData({
            valid: true,
            value: buildDurationValue(),
          })
        }
      })

      function allFieldsEmpty() {
        return Array.from(form).every(
          (field) => field.value == '' || field.value == '00'
        )
      }

      // trigger validation as soon as user clicks outside of form
      document.addEventListener('click', ({ target }) => {
        if (!form.contains(target) && !allFieldsEmpty()) {
          form.reportValidity()
        }
      })

      function validateField(fieldName, value) {
        if (value != '' && fieldName != 'hours' && parseInt(value) > 59) {
          const errMsg = `Invalid value for ${fieldName}`
          validationErrors.set(fieldName, errMsg)
        } else {
          validationErrors.delete(fieldName)
        }
        renderValidationResult()
      }

      function validateGeneral() {
        if (
          JFCustomWidget.getWidgetSetting('CustomIsRequired') == 'Yes' &&
          allFieldsEmpty()
        ) {
          validationErrors.set('allFieldsEmpty', 'Please enter a time.')
        } else {
          validationErrors.delete('allFieldsEmpty')
        }
        renderValidationResult()
      }

      function renderValidationResult() {
        if (validationErrors.size === 0) {
          errorsContainer.innerHTML = ''
        } else {
          errorsContainer.innerHTML = [...validationErrors.values()][0]
        }
      }

      // if (JFCustomWidget.getWidgetSetting('CustomIsRequired') == 'Yes') {
      //   JFCustomWidget.makeWidgetRequired()
      // }

      // JFCustomWidget.subscribe('ready', () => {

      // })

      function buildDurationValue() {
        return allFieldsEmpty()
          ? ''
          : [...new FormData(form).values()].map((val) => val || '00').join(':')
      }

      // subscribe to form submit event
      JFCustomWidget.subscribe('submit', () => {
        const durationValue = buildDurationValue()

        // console.log('durationValue', durationValue)
        // validateGeneral()

        // temp
        const data = {
          valid: validationErrors.size == 0,
          value: durationValue,
        }
        console.log('data for sendSubmit', data)

        // send value to JotForm
        JFCustomWidget.sendSubmit({
          valid: validationErrors.size == 0,
          value: durationValue,
        })
      })
    </script>
  </body>
</html>
